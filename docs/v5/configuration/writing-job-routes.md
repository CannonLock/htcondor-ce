Writing Job Routes
==================

Generic Routes
--------------

This section contains general information about job routes that can be used regardless of the type of batch system at
your site.
New routes should be placed in `/etc/condor-ce/config.d/99-local.conf`, not the original `02-ce-*.conf`.

### Required fields

The minimum requirements for a route are that you specify the type of batch system that jobs should be routed to and a
name for each route.
Default routes can be found in `/usr/share/condor-ce/config.d/02-ce-<batch system>-defaults.conf`, provided by the
`htcondor-ce-<batch system>` packages.

#### Batch system

Each route needs to indicate the type of batch system that jobs should be routed to.
For HTCondor batch systems, the `TargetUniverse` attribute needs to be set to `5` or `"vanilla"`.
For all other batch systems, the `TargetUniverse` attribute needs to be set to `9` or `"grid"` and the `GridResource`
attribute needs to be set to `"batch <batch system>"` (where `<batch system>` can be one of `pbs`, `slurm`, `lsf`, or
`sge`).

```hl_lines="3 7 8"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Route jobs to HTCondor";
]
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Route jobs to PBS";
]
@jre
```

#### Route name

To identify routes, you will need to assign a name to the route with the `name` attribute:

```hl_lines="4"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Route jobs to HTCondor";
]
@jre
```

The name of the route will be useful in debugging since it shows up in the output of
[condor\_ce\_job\_router\_info](../troubleshooting/troubleshooting.md#condor_ce_job_router_info),
the [JobRouterLog](../troubleshooting/troubleshooting.md#jobrouterlog),
and in the ClassAd of the routed job, which can be viewed with
[condor\_ce\_q](../troubleshooting/troubleshooting.md#condor_ce_q) or
[condor\_ce\_history](../troubleshooting/troubleshooting.md#condor_ce_history).

### Writing multiple routes

!!! note
    Before writing multiple routes, consider the details of [how jobs match to job routes](#how-jobs-match-to-job-routes)

If your batch system needs incoming jobs to be sorted (e.g. if different VO's need to go to separate queues),
you will need to write multiple job routes where each route is enclosed by square brackets.
The following routes takes incoming jobs that have a `queue` attribute set to `"analy"` and routes them to the site's
HTCondor batch system.
Any other jobs will be sent to that site's PBS batch system.

```hl_lines="2 6 7 12"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Route jobs to HTCondor";
  Requirements = (TARGET.queue =?= "analy");
]
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Route jobs to PBS";
  Requirements = (TARGET.queue =!= "analy");
]
@jre
```

### Writing comments

To write comments you can use `#` to comment a line:

```hl_lines="5"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "# comments";
  # This is a comment
]
@jre
```

### Setting attributes for all routes

To set an attribute that will be applied to all routes, you will need to ensure that `MERGE_JOB_ROUTER_DEFAULT_ADS` is
set to `True` (check the value with [condor\_ce\_config\_val](../troubleshooting/troubleshooting.md#condor_ce_config_val))
and use the [set_](#setting-attributes) function in the `JOB_ROUTER_DEFAULTS`.
The following configuration sets the `Periodic_Hold` attribute for all routes:

```hl_lines="7"
# Use the defaults generated by the condor_ce_router_defaults script.  To add
# additional defaults, add additional lines of the form:
#
#   JOB_ROUTER_DEFAULTS = $(JOB_ROUTER_DEFAULTS) [set_foo = 1;]
#
MERGE_JOB_ROUTER_DEFAULT_ADS=True
JOB_ROUTER_DEFAULTS = $(JOB_ROUTER_DEFAULTS) [set_Periodic_Hold = (NumJobStarts >= 1 && JobStatus == 1) || NumJobStarts > 1;]
```

### Filtering jobs based on…

To filter jobs, use the `Requirements` attribute.
Jobs will evaluate against the ClassAd expression set in the `Requirements` and if the expression evaluates to `TRUE`,
the route will match.
More information on the syntax of ClassAd's can be found in the
[HTCondor manual](https://htcondor.readthedocs.io/en/latest/misc-concepts/classad-mechanism.html).
For an example on how incoming jobs interact with filtering in job routes, consult [this document](../remote-job-submission.md).

When setting requirements, you need to prefix job attributes that you are filtering with `TARGET.` so that the job route
knows to compare the attribute of the incoming job rather than the route’s own attribute.
For example, if an incoming job has a `queue = "analy"` attribute, then the following job route will not match:

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Filtering by queue";
  queue = "not-analy";
  Requirements = (queue =?= "analy");
]
@jre
```

This is because when evaluating the route requirement, the job route will compare its own `queue` attribute to "analy"
and see that it does not match.
You can read more about comparing two ClassAds in the
[HTCondor manual](https://htcondor.readthedocs.io/en/latest/misc-concepts/classad-mechanism.html#classad-operators).

!!! note
    If you have an HTCondor batch system, note the difference with [set\_requirements](#setting-routed-job-requirements).

!!! note
    Before writing multiple routes, consider the details of [how jobs match to job routes](#how-jobs-match-to-job-routes).

#### Glidein queue

To filter jobs based on their glidein queue attribute, your routes will need a `Requirements` expression using the
incoming job's `queue` attribute.
The following entry routes jobs to HTCondor if the incoming job (specified by `TARGET`) is an `analy` (Analysis) glidein:

```hl_lines="5"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Filtering by queue";
  Requirements = (TARGET.queue =?= "analy");
]
@jre
```

#### Job submitter

To filter jobs based on who submitted it, your routes will need a `Requirements` expression using the incoming job's `Owner` attribute. The following entry routes jobs to the HTCondor batch system if the submitter is `usatlas2`:

```hl_lines="5"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Filtering by job submitter";
  Requirements = (TARGET.Owner =?= "usatlas2");
]
@jre
```

Alternatively, you can match based on regular expression. The following entry routes jobs to the PBS batch system if the submitter's name begins with `usatlas`:

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Filtering by job submitter (regular expression)";
  Requirements = regexp("^usatlas", TARGET.Owner);
]
@jre
```

#### VOMS attribute

To filter jobs based on the subject of the job's proxy, your routes will need a `Requirements` expression using the incoming job's `x509UserProxyFirstFQAN` attribute. The following entry routes jobs to the PBS batch system if the proxy subject contains `/cms/Role=Pilot`:

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Filtering by VOMS attribute (regex)";
  Requirements = regexp("\/cms\/Role\=pilot", TARGET.x509UserProxyFirstFQAN);
]
@jre
```

### Setting a default…

This section outlines how to set default job limits, memory, cores, and maximum walltime. For an example on how users can override these defaults, consult [this document](../remote-job-submission.md#submit-the-job).

#### Maximum number of jobs

To set a default limit to the maximum number of jobs per route, you can edit the configuration variable `CONDORCE_MAX_JOBS` in `/etc/condor-ce/config.d/01-ce-router.conf`:

```
CONDORCE_MAX_JOBS = 10000
```

!!! note
    The above configuration is to be placed directly into the HTCondor-CE configuration, not into a job route.

#### Maximum memory

To set a default maximum memory (in MB) for routed jobs, set the attribute `default_maxMemory`:

```hl_lines="7"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Request memory";
  # Set the requested memory to 1 GB
  set_default_maxMemory = 1000;
]
@jre
```

#### Number of cores to request

To set a default number of cores for routed jobs, set the attribute `default_xcount`:

```hl_lines="7"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Request CPU";
  # Set the requested cores to 8
  set_default_xcount = 8;
]
@jre
```

#### Maximum walltime

To set a default maximum walltime (in minutes) for routed jobs, set the attribute `default_maxWallTime`:

```hl_lines="7"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Setting WallTime";
  # Set the max walltime to 1 hr
  set_default_maxWallTime = 60;
]
@jre
```

### Setting job environments ###

HTCondor-CE offers two different methods for setting environment variables of routed jobs:

- `CONDORCE_PILOT_JOB_ENV` configuration, which should be used for setting environment variables for all routed jobs to
  static strings.
- `set_default_pilot_job_env` job route configuration, which should be used for setting environment variables:
    - Per job route
    - To values based on incoming job attributes
    - Using [ClassAd functions](https://htcondor.readthedocs.io/en/latest/misc-concepts/classad-mechanism.html#predefined-functions)

Both of these methods use the new HTCondor format of the
[environment command](https://htcondor.readthedocs.io/en/latest/man-pages/condor_submit.html#index-14), which is
described by environment variable/value pairs separated by whitespace and enclosed in double-quotes.
For example, the following HTCondor-CE configuration would result in the following environment for all routed jobs:

``` tab="HTCondor-CE Configuration"
CONDORCE_PILOT_JOB_ENV = "WN_SCRATCH_DIR=/nobackup/ http_proxy=proxy.wisc.edu"
```

```bash tab="Resulting Environment"
WN_SCRATCH_DIR=/nobackup/
http_proxy=proxy.wisc.edu
```

Contents of `CONDORCE_PILOT_JOB_ENV` can reference other HTCondor-CE configuration using HTCondor's configuration
[$() macro expansion](https://htcondor.readthedocs.io/en/stable/admin-manual/introduction-to-configuration.html#configuration-file-macros).
For example, the following HTCondor-CE configuration would result in the following environment for all routed jobs:

``` tab="HTCondor-CE Configuration"
LOCAL_PROXY = proxy.wisc.edu
CONDORCE_PILOT_JOB_ENV = "WN_SCRATCH_DIR=/nobackup/ http_proxy=$(LOCAL_PROXY)"
```

```bash tab="Resulting Environment"
WN_SCRATCH_DIR=/nobackup/
http_proxy=proxy.wisc.edu
```

To set environment variables per job route, based on incoming job attributes, or using ClassAd functions, add
`set_default_pilot_job_env` to your job route configuration.
For example, the following HTCondor-CE configuration would result in this environment for a job with these attributes:

``` tab="HTCondor-CE Configuration" hl_lines="5 6 7" 
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Local_Condor";
  set_default_pilot_job_env = strcat("WN_SCRATCH_DIR=/nobackup",
                                     " PILOT_COLLECTOR=", JOB_COLLECTOR,
                                     " ACCOUNTING_GROUP=", toLower(JOB_VO));
]
@jre
```

``` tab="Incoming Job Attributes"
JOB_COLLECTOR = "collector.wisc.edu"
JOB_VO = "GLOW"
```

``` bash tab="Resulting Environment"
WN_SCRATCH_DIR=/nobackup/
PILOT_COLLECTOR=collector.wisc.edu
ACCOUNTING_GROUP=glow
```

!!!tip "Debugging job route environment expressions"
    While constructing `set_default_pilot_job_env` expressions, try wrapping your expression in
    [debug()](#debugging-routes) to help with any issues that may arise.
    Make sure to remove `debug()` after you're done!

### Editing attributes…

The following functions are operations that affect job attributes and are evaluated in the following order:

1.  `copy_*`
2.  `delete_*`
3.  `set_*`
4.  `eval_set_*`

After each job route’s ClassAd is [constructed](#how-job-routes-are-constructed), the above operations are evaluated in order. For example, if the attribute `foo` is set using `eval_set_foo` in the `JOB_ROUTER_DEFAULTS`, you'll be unable to use `delete_foo` to remove it from your jobs since the attribute is set using `eval_set_foo` after the deletion occurs according to the order of operations. To get around this, we can take advantage of the fact that operations defined in `JOB_ROUTER_DEFAULTS` get overridden by the same operation in `JOB_ROUTER_ENTRIES`. So to 'delete' `foo`, we would add `eval_set_foo = ""` to the route in the `JOB_ROUTER_ENTRIES`, resulting in `foo` being absent from the routed job.

More documentation can be found in the [HTCondor manual](http://research.cs.wisc.edu/htcondor/manual/v8.6/5_4HTCondor_Job.html#SECTION00644000000000000000).

#### Copying attributes

To copy the value of an attribute of the incoming job to an attribute of the routed job, use `copy_`. The following route copies the `environment` attribute of the incoming job and sets the attribute `Original_Environment` on the routed job to the same value:

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Copying attributes";
  copy_environment = "Original_Environment";
]
@jre
```

#### Removing attributes

To remove an attribute of the incoming job from the routed job, use `delete_`. The following route removes the `environment` attribute from the routed job:

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Copying attributes";
  delete_environment = True;
]
@jre
```

#### Setting attributes

To set an attribute on the routed job, use `set_`. The following route sets the Job's `Rank` attribute to 5:

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Setting an attribute";
  set_Rank = 5;
]
@jre
```

#### Setting attributes with ClassAd expressions

To set an attribute to a ClassAd expression to be evaluated, use `eval_set`. The following route sets the `Experiment` attribute to `atlas.osguser` if the Owner of the incoming job is `osguser`:

!!! note
    If a value is set in JOB\_ROUTER\_DEFAULTS with `eval_set_<variable>`, override it by using `eval_set_<variable>` in the `JOB_ROUTER_ENTRIES`.

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Setting an attribute with a !ClassAd expression";
  eval_set_Experiment = strcat("atlas.", Owner);
]
@jre
```

### Limiting the number of jobs

This section outlines how to limit the number of total or idle jobs in a specific route (i.e., if this limit is reached, jobs will no longer be placed in this route).

!!! note
    If you are using an HTCondor batch system, limiting the number of jobs is not the preferred solution: HTCondor manages fair share on its own via [user priorities and group accounting](http://research.cs.wisc.edu/htcondor/manual/v8.6/3_6User_Priorities.html).

#### Total jobs

To set a limit on the number of jobs for a specific route, set the [MaxJobs](http://research.cs.wisc.edu/htcondor/manual/v8.6/5_4HTCondor_Job.html#57134) attribute:

```hl_lines="6 12"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Limit the total number of jobs to 100";
  MaxJobs = 100;
]
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Limit the total number of jobs to 75";
  MaxJobs = 75;
]
@jre
```

#### Idle jobs

To set a limit on the number of idle jobs for a specific route, set the [MaxIdleJobs](http://research.cs.wisc.edu/htcondor/manual/v8.6/5_4HTCondor_Job.html#57135) attribute:

```hl_lines="5 10"
JOB_ROUTER_ENTRIES @=jre
[
  TargetUniverse = 5;
  name = "Limit the total number of idle jobs to 100";
  MaxIdleJobs = 100;
]
[
  TargetUniverse = 5;
  name = "Limit the total number of idle jobs to 75";
  MaxIdleJobs = 75;
]
@jre
```

### Debugging routes

To help debug expressions in your routes, you can use the `debug()` function. First, set the debug mode for the JobRouter by editing a file in `/etc/condor-ce/config.d/` to read

```
JOB_ROUTER_DEBUG = D_ALWAYS:2 D_CAT
```

Then wrap the problematic attribute in `debug()`:

```hl_lines="6"
JOB_ROUTER_ENTRIES @=jre
[
  GridResource = "batch pbs";
  TargetUniverse = 9;
  name = "Debugging a difficult !ClassAd expression";
  eval_set_Experiment = debug(strcat("atlas", Name));
]
@jre
```

You will find the debugging output in `/var/log/condor-ce/JobRouterLog`.

Getting Help
------------

If you have any questions or issues with configuring job routes, please [contact us](../../index.md#contact-us) for assistance.

language: minimal
jobs:
  include:
    - &run_tests
      # Template; subsequent uses modify 'env'
      env:
        - OS_TYPE=centos OS_VERSION=6 BUILD_ENV=uw_build DEPLOY_STAGE=false
      stage: test
      sudo: required
      services:
        - docker
      before_install:
        - sudo apt-get update
        - echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
        - sudo service docker restart
        - sleep 5
        - sudo docker pull centos:centos${OS_VERSION}
      script:
        - tests/setup_tests.sh
    - <<: *run_tests
      env:
        - OS_TYPE=centos OS_VERSION=7 BUILD_ENV=uw_build DEPLOY_STAGE=false
    - <<: *run_tests
      env:
        - OS_TYPE=centos OS_VERSION=6 BUILD_ENV=osg DEPLOY_STAGE=false
    - <<: *run_tests
      env:
        - OS_TYPE=centos OS_VERSION=7 BUILD_ENV=osg DEPLOY_STAGE=false

    - &deploy_rpm
      # Template; subsequent uses modify 'env'
      env:
        - OS_TYPE=centos OS_VERSION=6 BUILD_ENV=uw_build DEPLOY_STAGE=true
      stage: deploy
      sudo: required
      skip_cleanup: true
      services:
        - docker

      before_install:
        - sudo apt-get update
        - echo 'DOCKER_OPTS="-H tcp://127.0.0.1:2375 -H unix:///var/run/docker.sock -s devicemapper"' | sudo tee /etc/default/docker > /dev/null
        - sudo service docker restart
        - sleep 5
        - sudo docker pull centos:centos${OS_VERSION}
      script:
        - tests/setup_tests.sh
      deploy:
        - provider: script
          on:
            tags: true
            repo: matyasselmeci/htcondor-ce
          skip_cleanup: true
          script: bash travis-ci/build_rpms.sh
    - <<: *deploy_rpm
      env:
        - OS_TYPE=centos OS_VERSION=7 BUILD_ENV=uw_build DEPLOY_STAGE=true
